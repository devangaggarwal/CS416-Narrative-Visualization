<!DOCTYPE html>
<html = lang="">
<body>
<script src="https://d3js.org/d3.v6.min.js"></script>
  <div>
      <label for="state"><strong>Select State:</strong></label>
      <select id="state">
      </select>
      
  </div>
<script>
let svg = d3.select("body").append("svg")
	.attr("width", 1440)
	.attr("height", 750);

//store the width and height for later
let width = +svg.attr("width");
let height = +svg.attr("height");

//render the data
function render(data) {

	let xVal = d => d.date; //gets the date for a value d
	let yVal = d => d.deaths; //gets the cases amount for a value d

	//set the margins
	let margin = {
		top: 100,
		right: 150,
		bottom: 100,
		left: 325
	};

	//these set the width and height of the inner chart
	let innerWidth = width - margin.left - margin.right;
	let innerHeight = height - margin.top - margin.bottom;

	/*

	SET UP SCALES

	*/

	let scaleX = d3.scaleTime() //sets up how dates will scale
		.domain([d3.min(data, xVal), d3.max(data, xVal)]).nice() //the data space, but nice() rounds it cleanly
		.range([0, innerWidth]); //the pixel space

	let xAxis = d3.axisBottom(scaleX) //the bottom axis is connected to the scaleX now
		.tickSize(-innerHeight)
		.tickPadding(20)
		.ticks(12)
		.tickFormat(d3.timeFormat("%b - %e"));

	let scaleY = d3.scaleLinear() //sets up how cases, y axis values will scale
		.domain([0, d3.max(data, yVal)]).nice()
		.range([innerHeight, 0])

	let yAxis = d3.axisLeft(scaleY) //left axis is connected to the scaleY now
		.tickPadding(20)
		.tickSize(-innerWidth);

	let g = svg.append("g")
		.attr("transform", `translate(${margin.left}, ${margin.top})`); //moves the chart out into clear space

	let yG = g.append("g") //adds a grouping for the cases, y axis
		.call(yAxis)
		.attr("font-size", 16); //size of number of cases labels

	yG.append("text") //add the y axis label
		.attr("font-size", 22)
		.attr("fill", "black")
		.text("New Deaths")
		.attr("y", innerHeight / 2)
		.attr("x", -90);
	
	let xG = g.append("g") //adds another axis grouping for the x axis, sets up labels and ticks
		.call(xAxis)
		.attr("transform", `translate(0, ${innerHeight})`) //moves the dates to bottom
		.attr("font-size", 16);

	xG.append("text") //add the label below x axis
		.attr("font-size", 22)
		.attr("fill", "black")
		.text("Month")
		.attr("y", 70)
		.attr("x", innerWidth / 2);

	g.append("text") //adds another grouping for the name of the line chart
		.attr("font-family", "sans-serif")
		.text(desiredCode + " COVID-19 Deaths - 2022")
		.attr("font-size", 26)
		.attr("y", -20)
		.attr("x", innerWidth / 4);

	/*

	DRAW THE LINE

	*/

	let line = d3.line() //defines the x and y of the line
		.x(d => scaleX(xVal(d)))
		.y(d => scaleY(yVal(d)));

	g.append("path") //add the line or path
		.datum(data)
		.attr("fill", "none")
		.attr("stroke", "#00A15F")
		.attr("stroke-width", 2)
		.attr("stroke-linejoin", "round") //smooths line a bit
		.attr("stroke-linecap", "round") //smooths line a bit
		.attr("d", line); //call line to draw line
}

let desiredCode = "USA";
d3.csv("new_countries.csv", function(d) { //for each entry
	if (d["Location.Code"] == desiredCode && +d["Date.Year"] == 2022 && +d["Date.Month"] <= 7) {
		return {	//parse date from multiple entries
			date: d3.timeParse("%Y-%m-%d")(d["Date.Year"] + "-" + d["Date.Month"] + "-" + d["Date.Day"]),
			deaths: +d["Data.Deaths"]
		};
	}
}).then(function(data) {
	render(data); //then render the data as it has been fully processed
});
const type = d3.annotationLabel

const annotations = [{
  note: {
    label: "YO WASSUP BRO",
    bgPadding: 20,
    title: "Annotations :)"
  },
  //can use x, y directly instead of data
  className: "show-bg",
  dy: 300,
  dx: 324
}]

const parseTime = d3.timeParse("%d-%b-%y")
const timeFormat = d3.timeFormat("%d-%b-%y")

//Skipping setting domains for sake of example
const x = d3.scaleTime().range([0, 800])
const y = d3.scaleLinear().range([300, 0])

const makeAnnotations = d3.annotation()
  .editMode(true)
  //also can set and override in the note.padding property
  //of the annotation object
  .notePadding(15)
  .type(type)
  //accessors & accessorsInverse not needed
  //if using x, y in annotations JSON
  .accessors({
    x: d => x(parseTime(d.date)),
    y: d => y(d.close)
  })
  .accessorsInverse({
     date: d => timeFormat(x.invert(d.x)),
     close: d => y.invert(d.y)
  })
  .annotations(annotations)

d3.select("svg")
  .append("g")
  .attr("class", "annotation-group")
  .call(makeAnnotations)

</script>
<div id="my_dataviz"></div>
<script>
// set the dimensions and margins of the graph
var margin = {top: 10, right: 30, bottom: 90, left: 60},
    width = 460 - margin.left - margin.right,
    height = 450 - margin.top - margin.bottom;
  
// append the svg object to the body of the page
var svg = d3.select("#my_dataviz")
  .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");
var tooltip = d3.select("body").append("div")
	.style("position", "absolute")
    .style("z-index", "10")
    .style("visibility", "hidden")
    .style("background", "#ffffff")
    .text("a simple tooltip");

// Parse the Data
d3.csv("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv", function(data) {

var select = d3.select("#state")
   .attr('class','select')
    .on('change',onchange)

var options = select
  .selectAll('option')
    .data(d3.map(data, function(d){return d.state;}).keys())
    .enter()
	.append('option')
	.text(function (d) { return d; })
    .attr("value",function(d){return d;});

var selectState = "Washington";
function onchange() {
	selectState = d3.select('select').property('value')
    d3.selectAll('svg').remove();
    svg = d3.select("#my_dataviz")
  .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");
    displayChart(data, selectState);
};

function filterData(data, s) {
	var fData = data.filter(function(d) {
        var year = d.date.substring(0,4);
        var month = d.date.substring(5,7);
        var day = d.date.substring(8,10);
    	return d.state == s && year == "2021" && month <= "07" && day == "01"
    });
   
	return fData;
};

displayChart(data, selectState);

function displayChart(data, selectState) {
    var stateData = filterData(data, selectState);
    console.log(stateData);
    stateData.forEach(function(d) {
        d.cases = d.cases/1000;
        var year = d.date.substring(0,4);
        var month = d.date.substring(5,7);
        var day = d.date.substring(8,10);
        var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        var monthValue = months[parseInt(month) - 1];
        d.date = monthValue;
    });
    // X axis
     var x = d3.scaleBand()
      .range([ 0, width ])
      .domain(d3.map(stateData, function(d){return d.date;}).keys())
      .padding(0.2);
    svg.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x))
      .selectAll("text")
        .attr("transform", "translate(-10,0)rotate(-45)")
        .style("text-anchor", "end");

    var casesMin = d3.min(stateData, function(d) { return d.cases; } );
    var casesMax = d3.max(stateData, function(d) { return d.cases; } );
    console.log(casesMin, casesMax);

    // Add Y axis
    var y = d3.scaleLinear()
      .domain([0, casesMax])
      .range([ height, 0])
    svg.append("g")
      .call(d3.axisLeft(y).ticks(5));

    // Add the text label for the Y axis
    svg.append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 0 - margin.left)
      .attr("x",0 - (height / 2))
      .attr("dy", "1em")
      .style("text-anchor", "middle")
      .text("Cases(in 1000s)");

    // Bars
    svg.selectAll("mybar")
      .data(stateData)
      .enter()
      .append("rect")
        .attr("x", function(d) { 
        	return x(d.date);
        })
        .attr("width", x.bandwidth())
        .attr("fill", "#69b3a2")
        // no bar at the beginning thus:
        .attr("height", function(d) { return height - y(0); }) // always equal to 0
        .attr("y", function(d) { return y(0); })
        .on("mouseover", function(d){tooltip.text("Deaths:\n" + d.deaths); return tooltip.style("visibility", "visible");})
      .on("mousemove", function(){return tooltip.style("top", (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
      .on("mouseout", function(){return tooltip.style("visibility", "hidden");});

    // Animation
    svg.selectAll("rect")
      .transition()
      .duration(800)
      .attr("y", function(d) { return y(d.cases); })
      .attr("height", function(d) {  	
            return Math.max(height - y(d.cases), 0);
       })
      .delay(function(d,i){console.log(i) ; return(i*100)})
}
    });
</script>
</body>
</html>
